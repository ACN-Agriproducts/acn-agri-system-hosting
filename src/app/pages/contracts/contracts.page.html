<ion-header>
    <app-header-toolbar titulo="Contract"></app-header-toolbar>
    <ion-toolbar class="ion-align-items-stretch">
        <ion-segment class="ion-justify-content-start" value="0"
            (ionChange)="changedContractType($event)">
            <ion-segment-button *ngFor="let tab of tabData; let index = index" [value]="index">
                <ion-label>{{tab.label}}</ion-label>
            </ion-segment-button>
        </ion-segment>
    </ion-toolbar>
    <ion-toolbar>
        <ion-segment class="ion-justify-content-start" value="active,closed,pending,cancelled"
            (ionChange)="segmentChanged($event)">
            <ion-segment-button value="active,closed,pending,cancelled">
                <ion-label>All</ion-label>
            </ion-segment-button>
            <ion-segment-button value="active">
                <ion-label>Active</ion-label>
            </ion-segment-button>
            <ion-segment-button value="closed">
                <ion-label>Closed</ion-label>
            </ion-segment-button>
            <!-- <ion-segment-button value="new">
        <ion-label>New Contract</ion-label>
      </ion-segment-button> -->
        </ion-segment>
    </ion-toolbar>
</ion-header>
<ion-content [fullscreen]="true" class="">
    <ng-container *ngTemplateOutlet="tabData?.[tabIndex].type; context: {$implicit: tabData?.[tabIndex]}"></ng-container>
</ion-content>

<!-- TODO -->
<ng-template #cards let-tabData>
    Card Template works!
</ng-template>

<ng-template #table let-tabData>
    <div class="content">
        <div class="header-filter">
            <ion-searchbar placeholder="search" [formControl]="searchIinput"></ion-searchbar>
            <ion-button color="dark" (click)='newContractButton()'>
                <ion-icon name="add" slot="start"></ion-icon>
                <ion-text>New</ion-text>
            </ion-button>
            <!-- <ion-button fill="outline" color="primary" (click)="openFilter($event)">
            <ion-icon name="filter" slot="start"></ion-icon>
            <ion-text>Filter</ion-text>
        </ion-button> -->
        </div>
        <ion-card class="table-header grid-item ion-hide-md-down">
            <ion-item lines="none" class="item-icon-hide-hover" (click)="sortList('id')">
                <div class="item-text-header item-text-number-header">
                    <ion-text>NÂ°</ion-text>
                    <ion-icon
                        [class.active-arrow]="sortField == 'id' && !assending" name="funnel-outline" color="primary">
                    </ion-icon>
                </div>
            </ion-item>
            <ion-item lines="none" class="item-icon-hide-hover" (click)="sortList('client')">
                <div class="item-text-header">
                    <ion-text>Customer</ion-text>
                    <ion-icon
                        [class.active-arrow]="sortField == 'client' && !assending" name="funnel-outline"
                        color="primary"></ion-icon>
                </div>
            </ion-item>
            <ion-item lines="none" matTooltip="Contract Date">
                <div class="item-text-header item-icon-hide-hover">
                    <ion-text>Date</ion-text>
                    <ion-icon
                        [class.active-arrow]="sortField == 'id' && !assending" name="funnel-outline" color="primary">
                    </ion-icon>
                </div>
            </ion-item>
            <ion-item lines="none" class="item-icon-hide-hover" (click)="sortList('status')">
                <div class="item-text-header">
                    <ion-text>State</ion-text>
                    <ion-icon
                        [class.active-arrow]="sortField == 'status' && !assending" name="funnel-outline"
                        color="primary"></ion-icon>
                </div>
            </ion-item>
            <ion-item lines="none" class="item-icon-hide-hover" (click)="sortList('product')" matTooltip="Product">
                <div class="item-text-header">
                    <ion-text>Product</ion-text>
                    <ion-icon
                        [class.active-arrow]="sortField == 'product' && !assending" name="funnel-outline"
                        color="primary"></ion-icon>
                </div>
            </ion-item>
            <ion-item lines="none" class="item-icon-hide-hover" (click)="sortList('quantity')">
                <div class="item-text-header item-icon-hide-hover">
                    <ion-text>Delivered</ion-text>
                    <ion-icon
                        [class.active-arrow]="sortField == 'quantity' && !assending" name="funnel-outline"
                        color="primary"></ion-icon>
                </div>
            </ion-item>
            <ion-item lines="none" class="item-icon-hide-hover" (click)="sortList('quantity')">
                <div class="item-text-header item-icon-hide-hover">
                    <ion-text>Bushels</ion-text>
                    <ion-icon
                        [class.active-arrow]="sortField == 'quantity' && !assending" name="funnel-outline"
                        color="primary"></ion-icon>
                </div>
            </ion-item>
            <ion-item lines="none" matTooltip="Price per Bushel" (click)="sortList('price')">
                <div class="item-text-header item-icon-hide-hover">
                    <ion-text>Price</ion-text>
                    <ion-icon
                        [class.active-arrow]="sortField == 'price' && !assending" name="funnel-outline" color="primary">
                    </ion-icon>
                </div>
            </ion-item>
            <ion-item lines="none">
                <div class="item-text-header item-icon-hide-hover">
                    <ion-text>Total</ion-text>
                    <ion-icon
                        [class.active-arrow]="sortField == 'total' && !assending" name="funnel-outline" color="primary">
                    </ion-icon>
                </div>
            </ion-item>
            <!-- <ion-item lines="none">
            <div class="item-text-header">
                <ion-text>Manage</ion-text>
            </div>
        </ion-item> -->
        </ion-card>
        
        <ion-card class="table-body">
            <!-- (contextmenu)="openOptions($event)" -->
            <!-- <ion-virtual-scroll approxItemHeight="320px" [items]="dataList"> -->
            <ng-container *ngFor="let contractsPromise of tabData.data[0].contracts"> 
                <div *ngFor="let contract of (contractsPromise | async)?.['docs']">
                    <div (contextmenu)="openOptions($event)" class="grid-item item-table">
                        <ion-item lines="none">
                            <ion-text color="dark" class="item-text-number">{{contract.data().id}}</ion-text>
                        </ion-item>
                        <ion-item lines="none">
                            <ion-text color="primary" class="item-text-customer">
                                {{
                                contract.data().clientName | titlecase | slice:0:25
                                }}
                                <span *ngIf="contract.data().clientName.length>25">...</span>
                            </ion-text>
                        </ion-item>
                        <ion-item lines="none">
                            <ion-text>{{contract.data().date | date}}</ion-text>
                        </ion-item>
                        <ion-item lines="none">
                            <ion-text class="item-status" [class.pending]="contract.data().status === 'pending'"
                                [class.active]="contract.data().status === 'active'" [class.close]="contract.data().status === 'closed'"
                                [class.cancel]="contract.data().status === 'cancelled'">{{contract.data().status}}
                            </ion-text>
                        </ion-item>
                        <ion-item lines="none">
                            <ion-text class="item-text-price" color="dark">
                                {{contract.data().product.id | titlecase}}
                            </ion-text>
                        </ion-item>
                        <ion-item lines="none">
                            <ion-text class="item-text-price" color="dark"
                                [matTooltip]="getDeliveredTooltip(contract.data())"
                                matTooltipClass="multiline-tooltip">
                                {{contract.data().currentDelivered.getBushelWeight(contract.data().productInfo).toFixed(2)}}
                            </ion-text>
                        </ion-item>
                        <ion-item lines="none">
                            <ion-text class="item-text-price" color="dark"
                                [matTooltip]="getQuantityTooltip(contract.data())"
                                matTooltipClass="multiline-tooltip">
                                {{contract.data().quantity.getBushelWeight(contract.data().productInfo).toFixed(2)}}
                            </ion-text>
                        </ion-item>
                        <ion-item lines="none">
                            <ion-text class="item-text-price" color="dark">
                                {{contract.data().pricePerBushel | currency:'$'}}
                            </ion-text>
                        </ion-item>
                        <ion-item lines="none">
                            <ion-text class="item-text-price" color="dark">
                                {{contract.data().quantity.getBushelWeight(contract.data().productInfo) * contract.data().pricePerBushel | currency:'$'}}
                            </ion-text>
                        </ion-item>
                        <ion-item lines="none" class="ion-hide-md-down">
                            <div class="content-button">
                                <ion-buttons>
                                    <ion-button color="medium" slot="end" (click)='openContractOptions($event, contract.data())'>
                                        <ion-icon name="ellipsis-vertical-outline" slot="icon-only"></ion-icon>
                                    </ion-button>
                                </ion-buttons>
                            </div>
                        </ion-item>
                    </div>
                </div>
            <!-- </ion-virtual-scroll> -->
            </ng-container>
        </ion-card>
    </div>
    <ion-infinite-scroll #infiniteScroll threshold="200px" (ionInfinite)="infiniteContracts($event)">
        <ion-infinite-scroll-content
            loadingSpinner="bubbles"
            loadingText="Loading more data...">
        </ion-infinite-scroll-content>
    </ion-infinite-scroll>
</ng-template>