<app-header-toolbar titulo="New Contract"></app-header-toolbar>

<ion-content>
  <ion-row>
    <ion-col size-xl='5' size-xs='12'>
      <ion-card>
        <ion-card-content>
          <ion-row>
            <ion-col size-xs='4' size-sm='3' size-md='2'>
              <button mat-stroked-button color="primary" type="button" (click)="openClientSelect()">Client:</button>
            </ion-col>
            <ion-col size-xs='8' size-sm='9' size-md='10'>
              <mat-form-field>
                <mat-label>Client Name</mat-label>
                <input matInput disabled [(ngModel)]="contract.clientName">
              </mat-form-field>
            </ion-col>
          </ion-row>
          <ion-row *ngIf="!useSameClient">
            <ion-col size-xs='4' size-sm='3' size-md='2'>
              <button mat-stroked-button color="primary" type="button" (click)="openTicketClientSelect()">Client:</button>
            </ion-col>
            <ion-col size-xs='8' size-sm='9' size-md='10'>
              <mat-form-field>
                <mat-label>Ticket Client</mat-label>
                <input matInput [(ngModel)]="contract.clientTicketInfo.name">
              </mat-form-field>
            </ion-col>
          </ion-row>
          <ion-row>
            <ion-col>
              <mat-checkbox [(ngModel)]="useSameClient">Use client info for tickets</mat-checkbox>
            </ion-col>
          </ion-row>
          <ion-row>
            <ion-col size-xs='8' size-sm='9'>
              <mat-form-field>
                <mat-label>Contract Type</mat-label>
                <mat-select [(ngModel)]="contract.type" (selectionChange)="contractTypeChange()">
                  <mat-option *ngFor="let type of contractTypeList | keyvalue" [value]="type.value">{{type.key}}</mat-option>
                </mat-select>
              </mat-form-field> 
            </ion-col>
            <ion-col size-xs='4' size-sm='3'>
              <mat-form-field>
                <mat-label>ID</mat-label>
                <input matInput [(ngModel)]="contract.id" type="number" required>
                <!-- <mat-spinner matSuffix [diameter]="20" *ngIf="contractForm.get('id').pending"></mat-spinner> -->
              </mat-form-field>
            </ion-col>
          </ion-row>
          <ion-row>
            <ion-col size-xs='8' size-sm='9'>
              <mat-form-field>
                <mat-label>Quantity</mat-label>
                <input matInput type='number' [(ngModel)]="contract.quantity.amount" type="number">
              </mat-form-field>
            </ion-col>
            <ion-col size-xs='4' size-sm='3'>
              <mat-form-field>
                <mat-label>Units</mat-label>
                <mat-select [(ngModel)]="contract.quantity.defaultUnits">
                  <mat-option value='bushels'>bushels</mat-option>
                  <mat-option value='lbs'>lbs</mat-option>
                  <mat-option value='CWT'>CWT</mat-option>
                  <mat-option value='mTon'>MTons</mat-option>
                </mat-select>
              </mat-form-field>
            </ion-col>
          </ion-row>
          <ion-row>
            <ion-col size='12'>
              <mat-form-field *ngIf="contract.productInfo">
                <mat-label>Product</mat-label>
                <mat-select [(ngModel)]="contract.productInfo.name">
                  <mat-option *ngFor="let product of productsList" [value]="product">{{product.ref.id}}</mat-option>
                </mat-select>
              </mat-form-field>
            </ion-col>
          </ion-row>
          <ion-row>
            <ion-col size-xs='8' size-sm='9'>
              <mat-form-field>
                <mat-label>Price</mat-label>
                <input matInput type='number' [(ngModel)]="price">
              </mat-form-field>
            </ion-col>
            <ion-col size-xs='4' size-sm='3'>
              <mat-form-field>
                <mat-label>Price Unit</mat-label>
                <mat-select [(ngModel)]="priceUnit">
                  <mat-option value='bushels'>bushels</mat-option>
                  <mat-option value='lbs'>lbs</mat-option>
                  <mat-option value='CWT'>CWT</mat-option>
                  <mat-option value='mTon'>MTons</mat-option>
                </mat-select>
              </mat-form-field>
            </ion-col>
          </ion-row>
          <ion-row>
            <ion-col size='12'>
              <mat-form-field>
                <mat-label>Market Price Per Bushel</mat-label>
                <input matInput [(ngModel)]="contract.market_price" type="number">
              </mat-form-field>
            </ion-col>
          </ion-row>
          <ion-row>
            <ion-col size='6'>
              <mat-form-field>
                <mat-label>U.S. Grade</mat-label>
                <input matInput [(ngModel)]="contract.grade" type="number">
              </mat-form-field>
            </ion-col>
            <ion-col size='6'>
              <mat-form-field>
                <mat-label>Aflatoxin</mat-label>
                <input matInput [(ngModel)]="contract.aflatoxin" type="number">
              </mat-form-field>
            </ion-col>
          </ion-row>
          <ion-row>
            <ion-col>
              <mat-form-field>
                <mat-label>Delivery Plants</mat-label>
                <mat-chip-list multiple [(ngModel)]="contract.plants" #chipList>
                  <mat-chip 
                    *ngFor="let plant of plantsList"
                    [value]="plant.ref.id"
                    (removed)="removePlantChip(plant.ref.id)">
                    {{plant.ref.id | titlecase}}
                    <button matChipRemove *ngIf="chipIsChosen(plant.ref.id); else addPlantButton">
                      <mat-icon>cancel</mat-icon>
                    </button>
                    <ng-template #addPlantButton>
                      <mat-icon matChipTrailingIcon (click)="addPlantChip(plant.ref.id)">add</mat-icon>
                    </ng-template>
                  </mat-chip>
                </mat-chip-list>
              </mat-form-field>
            </ion-col>
          </ion-row>
          <ion-row>
            <ion-col size='6'>
              <mat-form-field>
                <mat-label>Delivery Dates Start</mat-label>
                <input matInput [matDatepicker]="pickerStart" [(ngModel)]="contract.delivery_dates.begin">
                <mat-datepicker-toggle matSuffix [for]="pickerStart"></mat-datepicker-toggle>
                <mat-datepicker #pickerStart></mat-datepicker>
              </mat-form-field>
            </ion-col>
            <ion-col size='6'>
              <mat-form-field>
                <mat-label>Delivery Dates End</mat-label>
                <input matInput [matDatepicker]="pickerEnd" [(ngModel)]="contract.delivery_dates.end">
                <mat-datepicker-toggle matSuffix [for]="pickerEnd"></mat-datepicker-toggle>
                <mat-datepicker #pickerEnd></mat-datepicker>
              </mat-form-field>
            </ion-col>
          </ion-row>
          <ion-row>
            <ion-col size='6'>
              <mat-form-field>
                <mat-label>Payment</mat-label>
                <mat-select [(ngModel)]="contract.paymentTerms.before">
                  <mat-option [value]='true'>Before</mat-option>
                  <mat-option [value]='false'>After</mat-option>
                </mat-select>
              </mat-form-field>
            </ion-col>
            <ion-col size='6'>
              <mat-form-field>
                <mat-label>Scale</mat-label>
                <mat-select [(ngModel)]="contract.paymentTerms.origin">
                  <mat-option [value]='false'>Destination</mat-option>
                  <mat-option [value]='true'>Origin</mat-option>
                </mat-select>
              </mat-form-field>
            </ion-col>
            <ion-col size='6'>
              <mat-form-field>
                <mat-label>Payment Terms</mat-label>
                <input matInput [(ngModel)]="contract.paymentTerms.paymentTerms" type="number">
              </mat-form-field>
            </ion-col>
            <ion-col size='6'>
              <mat-form-field>
                <mat-label>Payment Terms Units</mat-label>
                <mat-select [(ngModel)]="contract.paymentTerms.measurement">
                  <mat-option value='lbs'>lbs</mat-option>
                  <mat-option value='trucks'>trucks</mat-option>
                  <mat-option value='bushels'>bushels</mat-option>
                </mat-select>
              </mat-form-field>
            </ion-col>
          </ion-row>
          <button mat-raised-button (click)="submitForm()" [disabled]="!formIsValid">Submit</button>
          <button 
          mat-button
          [disabled]="!formIsValid"
          printSectionId="printable-doc"
          [useExistingCss]='true'
          [printStyle]="{'#first-page' : {'font-size': '13px', 'line-height': '150%'}, '.terms-and-conditions' : {'font-size': 'x-small', 'line-height': '125%'} }"
          ngxPrint>
          PRINT
        </button>
        </ion-card-content>
      </ion-card>
      <ion-card>
        <ion-card-content>
          <ion-row *ngFor="let truckerGroup of truckerArray.controls; let index = index">
            <ion-col size-xs='8' size-sm='9' class="flex-column">
              <button mat-icon-button color="warn" (click)="removeTruckerGroup(index)">
                <mat-icon>delete</mat-icon>
              </button>
              <mat-form-field>
                <mat-label>Truckers</mat-label>
                <input  matInput
                        type="text"
                        placeholder="Trucker Name..."
                        [matAutocomplete]="truckerAuto"
                        [formControl]="truckerGroup.get('trucker') | as:formControl">
                <mat-autocomplete autoActiveFirstOption #truckerAuto>
                  <mat-option *ngFor="let trucker of filteredTruckerOptions[index] | async" [value]="trucker.name">
                    {{trucker.name}}
                  </mat-option>
                </mat-autocomplete>
              </mat-form-field>
            </ion-col>
            <ion-col size-xs='4' size-sm='3'>
              <mat-form-field>
                <mat-label>Freight</mat-label>
                <span matPrefix>$</span>
                <input  matInput 
                        formControlName="freight"
                        type="number"
                        min="0">
              </mat-form-field>
            </ion-col>
          </ion-row>
          <ion-row>
            <ion-col size="3">
              <button mat-flat-button color="primary" (click)="addTruckerGroup()">
                Add Trucker
              </button>
            </ion-col>
          </ion-row>
        </ion-card-content>
      </ion-card>
    </ion-col>
    <ion-col size-xl='7' size-xs='12'>
      <!-- <app-display-contract id='printable-doc' [contractForm]="contract" [weight]="this.contractWeight" [productsList]="this.productsList"></app-display-contract> -->
      <app-printable-contract 
        [contract]="contract" 
        [version]="contract.type"
        (contractTypesListEmitter)="contractTypeList = $event">
      </app-printable-contract>
    </ion-col>
  </ion-row>
</ion-content>
